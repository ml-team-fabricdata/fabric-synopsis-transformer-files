<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Synopsis Transformer - Fabric AI Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl p-6 bg-gray-800 rounded-lg shadow-lg space-y-8">
    <h1 class="text-3xl font-bold text-cyan-400 text-center">Synopsis Transformer</h1>

    <!-- API & User Inputs -->
    <div class="space-y-4">
      <div>
        <label class="block text-sm mb-1">Upload API Endpoint</label>
        <input id="uploadEndpoint" type="text" placeholder="https://your-api/upload"
          class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:ring focus:ring-cyan-500"/>
      </div>
      <div>
        <label class="block text-sm mb-1">Results API Endpoint</label>
        <input id="resultsEndpoint" type="text" placeholder="https://your-api/results"
          class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:ring focus:ring-cyan-500"/>
      </div>
      <div>
        <label class="block text-sm mb-1">User ID</label>
        <input id="userId" type="text" placeholder="rafa"
          class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:ring focus:ring-cyan-500"/>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-purple-400">Upload Files</h2>
      <input id="fileInput" type="file" accept=".vtt" multiple
        class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600"/>
      <button id="uploadBtn"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded font-semibold">
        Upload & Transform
      </button>
      <div id="uploadStatus" class="text-sm text-gray-400"></div>
    </div>

    <!-- Results Section -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-green-400">Results</h2>
      <button id="fetchBtn"
        class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded font-semibold">
        Fetch Results
      </button>
      <div id="results" class="space-y-4">
        <p class="text-gray-400">No results yet...</p>
      </div>
    </div>
  </div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const fetchBtn = document.getElementById("fetchBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const resultsDiv = document.getElementById("results");

    // Handle file upload
    uploadBtn.addEventListener("click", async () => {
      const endpoint = document.getElementById("uploadEndpoint").value.trim();
      const userId = document.getElementById("userId").value.trim();
      const files = document.getElementById("fileInput").files;

      if (!endpoint || !userId || files.length === 0) {
        alert("Please set endpoint, user ID and choose at least one file");
        return;
      }

      uploadStatus.textContent = "Uploading...";

      const fileArray = [];
      for (const file of files) {
        const text = await file.text();
        fileArray.push({
          file_name: file.name,
          file_content: text
        });
      }

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, files: fileArray })
        });

        const result = await response.json();
        if (response.ok) {
          uploadStatus.textContent = "Upload successful! " + JSON.stringify(result);
        } else {
          uploadStatus.textContent = "Error: " + JSON.stringify(result);
        }
      } catch (err) {
        uploadStatus.textContent = "Error: " + err.message;
      }
    });

    // Handle results fetch
    fetchBtn.addEventListener("click", async () => {
      const endpoint = document.getElementById("resultsEndpoint").value.trim();
      const userId = document.getElementById("userId").value.trim();

      if (!endpoint || !userId) {
        alert("Please set endpoint and user ID");
        return;
      }

      resultsDiv.innerHTML = "<p class='text-gray-400'>Loading...</p>";

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();
        if (!response.ok) {
          resultsDiv.innerHTML = `<pre class="text-red-400">${JSON.stringify(data, null, 2)}</pre>`;
          return;
        }

        const sessions = data.sessions || {};
        if (Object.keys(sessions).length === 0) {
          resultsDiv.innerHTML = "<p class='text-gray-400'>No sessions found</p>";
          return;
        }

        let html = "";
        for (const [session, details] of Object.entries(sessions)) {
          html += `
            <div class="p-4 bg-gray-700 rounded">
              <h2 class="font-bold text-lg text-purple-400">Session: ${session}</h2>
              <p class="text-sm text-gray-300">Files: ${details.count} Â· Size: ${details.total_size} bytes</p>
              <ul class="mt-2 space-y-2">
          `;
          details.files.forEach(file => {
            const s3Url = \`https://s3.console.aws.amazon.com/s3/object/synopsis-transformer-files?region=us-east-2&prefix=\${file.key}\`;
            html += `
              <li class="flex justify-between items-center bg-gray-800 px-3 py-2 rounded">
                <span class="text-sm">\${file.key} (\${file.size} bytes)</span>
                <a href="\${s3Url}" target="_blank"
                  class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                  Download
                </a>
              </li>
            `;
          });
          html += `</ul></div>`;
        }
        resultsDiv.innerHTML = html;
      } catch (err) {
        resultsDiv.innerHTML = `<pre class="text-red-400">Error: ${err.message}</pre>`;
      }
    });
  </script>
</body>
</html>
