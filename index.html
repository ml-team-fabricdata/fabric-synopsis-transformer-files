<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synopsis Transformer - Fabric AI Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .gradient-text {
            background: linear-gradient(to right, #22d3ee, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-bg {
            background: linear-gradient(to right, #0891b2, #7c3aed);
        }
        
        .gradient-bg:hover {
            background: linear-gradient(to right, #0e7490, #6d28d9);
        }

        .gradient-bg-green {
            background: linear-gradient(to right, #059669, #0891b2);
        }

        .gradient-bg-green:hover {
            background: linear-gradient(to right, #047857, #0e7490);
        }
        
        .backdrop-blur {
            backdrop-filter: blur(8px);
        }
        
        .grid-pattern {
            background-image: 
                linear-gradient(rgba(0,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #374151;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }

        .file-drop-zone {
            border: 2px dashed #374151;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #22d3ee;
            background-color: rgba(34, 211, 238, 0.05);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            overflow-y: auto;
            padding: 24px;
        }

        /* Result card styling similar to first code */
        .result-item {
            border: 1px solid #374151;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-2px);
        }

        /* Added styles for formatted output viewer */
        .output-section {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .output-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .output-item:hover {
            border-color: rgba(34, 211, 238, 0.5);
        }

        .collapsible-section {
            cursor: pointer;
            user-select: none;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 500px;
            overflow-y: auto;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid;
        }

        .badge-cyan {
            background: rgba(34, 211, 238, 0.2);
            color: #22d3ee;
            border-color: rgba(34, 211, 238, 0.5);
        }

        .badge-green {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.5);
        }

        .badge-yellow {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border-color: rgba(234, 179, 8, 0.5);
        }

        .badge-purple {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-color: rgba(168, 85, 247, 0.5);
        }
    </style>
</head>
<body class="min-h-screen bg-black relative overflow-x-hidden">
    <!-- Animated Background Grid -->
    <div class="absolute inset-0 grid-pattern animate-pulse"></div>

    <!-- Floating Futuristic Elements -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-20 right-20 opacity-20 floating-element">
            <div class="w-32 h-24 bg-gradient-to-br from-cyan-500/20 to-purple-500/20 rounded-lg border border-cyan-500/30 flex items-center justify-center backdrop-blur">
                <i data-lucide="brain" class="w-16 h-16 text-cyan-400"></i>
            </div>
        </div>
        <div class="absolute top-1/3 left-10 opacity-20 floating-element" style="animation-delay: -2s;">
            <div class="w-28 h-20 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-lg border border-purple-500/30 flex items-center justify-center backdrop-blur">
                <i data-lucide="cpu" class="w-12 h-12 text-purple-400"></i>
            </div>
        </div>
        <div class="absolute bottom-32 right-1/4 opacity-20 floating-element" style="animation-delay: -4s;">
            <div class="w-24 h-24 bg-gradient-to-br from-green-500/20 to-cyan-500/20 rounded-lg border border-green-500/30 flex items-center justify-center backdrop-blur">
                <i data-lucide="network" class="w-10 h-10 text-green-400"></i>
            </div>
        </div>
        <div class="absolute top-1/2 right-10 opacity-20 floating-element" style="animation-delay: -1s;">
            <div class="w-20 h-20 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-lg border border-yellow-500/30 flex items-center justify-center backdrop-blur">
                <i data-lucide="code-2" class="w-8 h-8 text-yellow-400"></i>
            </div>
        </div>
    </div>

    <div class="relative max-w-7xl mx-auto px-6 py-8">
        <!-- Header with Fabric AI Services Branding -->
        <div class="text-center space-y-4 mb-8">
            <div class="flex items-center justify-center gap-4 mb-4">
                <img
                    src="https://framerusercontent.com/assets/YhHtO4AfpyCgmWFZ6i3dcmRLcAI.png"
                    alt="Fabric AI Services"
                    class="h-10 w-auto"
                />
                <div class="h-6 w-px bg-gradient-to-b from-cyan-500 to-purple-500"></div>
                <span class="text-cyan-400 font-semibold text-base tracking-wide">FABRIC AI SERVICES</span>
            </div>

            <h1 class="text-4xl font-bold gradient-text">
                Synopsis Transformer
            </h1>
            <p class="text-lg text-gray-300 max-w-3xl mx-auto leading-relaxed">
                Advanced AI-powered content transformation engine. Upload VTT files, process them with AI, and browse your transformed results.
            </p>

            <!-- Tech Stats -->
            <div class="flex items-center justify-center gap-6 pt-2">
                <div class="flex items-center gap-2 text-cyan-400">
                    <i data-lucide="zap" class="w-3 h-3"></i>
                    <span class="text-xs font-mono">NEURAL ENGINE</span>
                </div>
                <div class="flex items-center gap-2 text-purple-400">
                    <i data-lucide="brain" class="w-3 h-3"></i>
                    <span class="text-xs font-mono">AI POWERED</span>
                </div>
                <div class="flex items-center gap-2 text-green-400">
                    <i data-lucide="network" class="w-3 h-3"></i>
                    <span class="text-xs font-mono">REAL-TIME</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Upload Panel -->
            <div class="lg:col-span-2">
                <div class="border border-gray-800 bg-gray-900/50 backdrop-blur rounded-lg shadow-2xl shadow-cyan-500/10">
                    <div class="border-b border-gray-800 p-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                            Upload & Transform
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- Configuration -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="baseEndpoint" class="text-sm font-semibold text-cyan-400 uppercase tracking-wider flex items-center gap-2">
                                    <i data-lucide="network" class="w-4 h-4"></i>
                                    API Endpoint
                                </label>
                                <input
                                    id="baseEndpoint"
                                    type="text"
                                    placeholder="https://your-api-gateway-url"
                                    class="w-full font-mono text-sm bg-black/50 border border-gray-700 text-white placeholder-gray-500 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 rounded-md px-3 py-2 outline-none"
                                />
                            </div>
                            <div class="space-y-2">
                                <label for="userId" class="text-sm font-semibold text-green-400 uppercase tracking-wider flex items-center gap-2">
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                    User ID
                                </label>
                                <input
                                    id="userId"
                                    type="text"
                                    placeholder="rafa"
                                    class="w-full font-mono text-sm bg-black/50 border border-gray-700 text-white placeholder-gray-500 focus:border-green-500 focus:ring-2 focus:ring-green-500/20 rounded-md px-3 py-2 outline-none"
                                />
                            </div>
                        </div>

                        <!-- File Drop Zone -->
                        <div class="space-y-4">
                            <label class="text-sm font-semibold text-purple-400 uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                VTT File Upload
                            </label>
                            <div id="fileDropZone" class="file-drop-zone p-6 rounded-lg text-center cursor-pointer">
                                <input type="file" id="fileInput" accept=".vtt" multiple class="hidden">
                                <div class="space-y-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-full flex items-center justify-center mx-auto border border-purple-500/30">
                                        <i data-lucide="upload" class="w-6 h-6 text-purple-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-white font-semibold">Drop VTT files here or click to browse</p>
                                        <p class="text-gray-400 text-sm mt-1">Supports multiple file upload</p>
                                    </div>
                                </div>
                            </div>
                            <div id="fileInfo" class="hidden p-4 bg-purple-500/10 border border-purple-500/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="file-check" class="w-5 h-5 text-purple-400"></i>
                                    <div>
                                        <p id="fileInfoText" class="text-white font-semibold"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Button -->
                        <div class="flex items-center gap-4 flex-wrap pt-4">
                            <button
                                id="uploadBtn"
                                class="gradient-bg text-white px-6 py-2.5 text-sm font-semibold shadow-lg shadow-cyan-500/25 transition-all duration-300 rounded-md flex items-center gap-2"
                            >
                                <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                                <span>Upload & Transform</span>
                            </button>
                            <span id="uploadStatus" class="text-sm text-gray-400 font-mono"></span>
                        </div>

                        <!-- Important Notice -->
                        <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                                <div class="text-sm text-yellow-200">
                                    <p class="font-semibold mb-1">Important Notice:</p>
                                    <p>If you see "✗ Upload failed" after clicking Upload & Transform, please wait approximately 30 seconds and then click the "Fetch Results" button. This is a timeout limitation in the test environment, not a processing error. Your files are still being processed successfully.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Info Panel -->
            <div class="lg:col-span-1">
                <div class="border border-gray-800 bg-gray-900/50 backdrop-blur rounded-lg shadow-2xl shadow-purple-500/10">
                    <div class="border-b border-gray-800 p-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                            Quick Guide
                        </h2>
                    </div>
                    <div class="p-6 space-y-4 text-sm text-gray-300">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-cyan-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-cyan-400 font-bold text-xs">1</span>
                            </div>
                            <p>Enter your API endpoint and User ID</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-purple-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-purple-400 font-bold text-xs">2</span>
                            </div>
                            <p>Upload one or more VTT files</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-green-400 font-bold text-xs">3</span>
                            </div>
                            <p>Click "Upload & Transform" to process</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-yellow-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-yellow-400 font-bold text-xs">4</span>
                            </div>
                            <p>Wait ~30 seconds, then click "Fetch Results"</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 bg-pink-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-pink-400 font-bold text-xs">5</span>
                            </div>
                            <p>View or download your processed files</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="mt-6">
            <div class="border border-gray-800 bg-gray-900/50 backdrop-blur rounded-lg shadow-2xl shadow-green-500/10">
                <div class="border-b border-gray-800 p-4 flex items-center justify-between">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        Processed Results
                    </h2>
                    <button
                        id="fetchBtn"
                        class="gradient-bg-green text-white px-4 py-2 text-sm font-semibold shadow-lg shadow-green-500/25 transition-all duration-300 rounded-md flex items-center gap-2"
                    >
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Fetch Results
                    </button>
                </div>
                <div id="results" class="p-6">
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gradient-to-br from-gray-800 to-gray-700 rounded-full flex items-center justify-center mx-auto mb-3 border border-gray-600">
                            <i data-lucide="inbox" class="w-6 h-6 text-gray-400"></i>
                        </div>
                        <p class="text-gray-400 font-mono text-xs">No results yet. Upload files to get started.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Viewer Modal -->
    <div id="jsonModal" class="modal">
        <div class="modal-content">
            <div class="border-b border-gray-700 p-4 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white flex items-center gap-3">
                    <i data-lucide="file-json" class="w-5 h-5 text-cyan-400"></i>
                    <span id="modalTitle">Result Viewer</span>
                </h3>
                <button id="closeModal" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <!-- Updated modal body to show formatted output instead of raw JSON -->
            <div class="modal-body" id="modalBody">
                <div id="formattedOutput"></div>
                <div id="rawJsonSection" class="mt-6">
                    <div class="collapsible-section output-section" onclick="toggleJsonSection()">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                JSON Response
                                <span class="text-xs text-gray-500 font-normal">(for debugging)</span>
                            </h4>
                            <i data-lucide="chevron-down" id="jsonChevron" class="w-5 h-5 text-gray-400 transition-transform"></i>
                        </div>
                    </div>
                    <div id="jsonCollapsible" class="collapsible-content">
                        <pre id="jsonContent" class="text-xs font-mono text-green-400 bg-black/50 p-4 rounded border border-gray-700 overflow-auto whitespace-pre-wrap mt-2"></pre>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 p-4 flex justify-end gap-3">
                <button id="copyJsonBtn" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 rounded-lg hover:bg-cyan-500/30 transition-all text-sm font-semibold flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    Copy JSON
                </button>
                <button id="downloadJsonBtn" class="px-4 py-2 bg-green-500/20 text-green-400 border border-green-500/50 rounded-lg hover:bg-green-500/30 transition-all text-sm font-semibold flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const uploadBtn = document.getElementById("uploadBtn");
        const fetchBtn = document.getElementById("fetchBtn");
        const uploadStatus = document.getElementById("uploadStatus");
        const resultsDiv = document.getElementById("results");
        const fileDropZone = document.getElementById("fileDropZone");
        const fileInput = document.getElementById("fileInput");
        const fileInfo = document.getElementById("fileInfo");
        const fileInfoText = document.getElementById("fileInfoText");
        const jsonModal = document.getElementById("jsonModal");
        const closeModal = document.getElementById("closeModal");
        const modalTitle = document.getElementById("modalTitle");
        const jsonContent = document.getElementById("jsonContent");
        const copyJsonBtn = document.getElementById("copyJsonBtn");
        const downloadJsonBtn = document.getElementById("downloadJsonBtn");

        let selectedFiles = [];
        let currentJsonData = null;
        let currentFileName = null;

        // Utility functions
        function showToast(title, description, variant = 'default') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="font-semibold">${title}</div>
                <div class="text-sm text-gray-300">${description}</div>
            `;
            
            if (variant === 'destructive') {
                toast.style.borderColor = '#ef4444';
                toast.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // File handling
        fileDropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('dragover');
        });
        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('dragover');
        });
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
            handleFileSelect(e.dataTransfer.files);
        });

        function handleFileSelect(files) {
            selectedFiles = Array.from(files);
            fileInfoText.textContent = `${selectedFiles.length} file(s) selected: ${selectedFiles.map(f => f.name).join(', ')}`;
            fileInfo.classList.remove("hidden");
            showToast('Files Selected', `${selectedFiles.length} file(s) ready for upload`);
        }

        // Upload handler
        uploadBtn.addEventListener("click", async () => {
            const baseEndpoint = document.getElementById("baseEndpoint").value.trim();
            const userId = document.getElementById("userId").value.trim();
            
            if (!baseEndpoint || !userId || selectedFiles.length === 0) {
                showToast('Error', 'Missing endpoint, user ID, or files', 'destructive');
                return;
            }

            uploadStatus.textContent = "Uploading...";
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `
                <div class="w-4 h-4 animate-spin mr-2">
                    <i data-lucide="loader-2" class="w-4 h-4"></i>
                </div>
                Processing...
            `;
            lucide.createIcons();

            const fileArray = [];
            for (const f of selectedFiles) {
                const text = await f.text();
                fileArray.push({ file_name: f.name, file_content: text });
            }

            try {
                const resp = await fetch(`${baseEndpoint}/upload`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, files: fileArray })
                });
                const data = await resp.json();
                
                if (resp.ok) {
                    uploadStatus.textContent = "✓ Upload successful";
                    showToast('Success', 'Files uploaded and processing started');
                } else {
                    uploadStatus.textContent = "✗ Upload failed";
                    showToast('Upload Failed', 'Please wait ~30 seconds and click "Fetch Results"', 'destructive');
                }
            } catch (err) {
                uploadStatus.textContent = "✗ Network error";
                showToast('Error', `${err.message}`, 'destructive');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    Upload & Transform
                `;
                lucide.createIcons();
            }
        });

        // Fetch results handler
        fetchBtn.addEventListener("click", async () => {
            const baseEndpoint = document.getElementById("baseEndpoint").value.trim();
            const userId = document.getElementById("userId").value.trim();
            
            if (!baseEndpoint || !userId) {
                showToast('Error', 'Missing endpoint or user ID', 'destructive');
                return;
            }

            resultsDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gradient-to-br from-gray-800 to-gray-700 rounded-full flex items-center justify-center mx-auto mb-3 border border-gray-600 animate-spin">
                        <i data-lucide="loader-2" class="w-6 h-6 text-gray-400"></i>
                    </div>
                    <p class="text-gray-400 font-mono text-xs">Loading results...</p>
                </div>
            `;
            lucide.createIcons();

            try {
                const resp = await fetch(`${baseEndpoint}/results`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    resultsDiv.innerHTML = `
                        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                            <pre class="text-red-400 text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    return;
                }

                const sessions = data.sessions || {};
                if (Object.keys(sessions).length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-12 h-12 bg-gradient-to-br from-gray-800 to-gray-700 rounded-full flex items-center justify-center mx-auto mb-3 border border-gray-600">
                                <i data-lucide="inbox" class="w-6 h-6 text-gray-400"></i>
                            </div>
                            <p class="text-gray-400 font-mono text-xs">No results found</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                let html = '<div class="space-y-6">';
                for (const [session, details] of Object.entries(sessions)) {
                    html += `
                        <div class="result-item p-6">
                            <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-700">
                                <i data-lucide="folder" class="w-5 h-5 text-purple-400"></i>
                                <h3 class="text-lg font-bold text-purple-400">Session: ${session}</h3>
                                <span class="ml-auto px-3 py-1 rounded-full text-xs font-semibold border bg-purple-500/20 text-purple-400 border-purple-500/50">
                                    ${details.files.length} files
                                </span>
                            </div>
                            <div class="space-y-3">
                    `;
                    
                    details.files.forEach(f => {
                        const s3Url = f.url || `https://synopsis-transformer-files.s3.us-east-2.amazonaws.com/${f.key}`;
                        const fileName = f.key.split('/').pop();
                        html += `
                            <div class="flex items-center justify-between p-4 bg-black/30 rounded-lg hover:bg-black/50 transition-colors border border-gray-700">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <i data-lucide="file-json" class="w-5 h-5 text-cyan-400 flex-shrink-0"></i>
                                    <span class="text-gray-300 text-sm font-mono truncate">${fileName}</span>
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <button 
                                        onclick="viewJson('${f.key}', '${fileName}')"
                                        class="px-3 py-1.5 bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 rounded-lg hover:bg-cyan-500/30 transition-all text-xs font-semibold flex items-center gap-1"
                                    >
                                        <i data-lucide="eye" class="w-3 h-3"></i>
                                        View
                                    </button>
                                    <a 
                                        href="${s3Url}" 
                                        target="_blank"
                                        class="px-3 py-1.5 bg-green-500/20 text-green-400 border border-green-500/50 rounded-lg hover:bg-green-500/30 transition-all text-xs font-semibold flex items-center gap-1"
                                    >
                                        <i data-lucide="download" class="w-3 h-3"></i>
                                        Download
                                    </a>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                lucide.createIcons();
                showToast('Success', `Found ${Object.keys(sessions).length} session(s)`);
            } catch (err) {
                resultsDiv.innerHTML = `
                    <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <pre class="text-red-400 text-sm">${err.message}</pre>
                    </div>
                `;
                showToast('Error', `${err.message}`, 'destructive');
            }
        });

        // JSON Viewer functions
        async function viewJson(fileKey, fileName) {
            try {
                modalTitle.textContent = fileName;
                document.getElementById('formattedOutput').innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';
                jsonContent.textContent = '';
                jsonModal.classList.add('show');
                lucide.createIcons();

                const baseEndpoint = document.getElementById("baseEndpoint").value.trim();
                const userId = document.getElementById("userId").value.trim();
                const response = await fetch(`${baseEndpoint}/results`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, action: "view", file_key: fileKey })
                });
                const data = await response.json();
                
                currentJsonData = data;
                currentFileName = fileName;
                
                // Display formatted output
                displayFormattedOutput(data);
                
                // Also set raw JSON for debugging
                jsonContent.textContent = JSON.stringify(data, null, 2);
                
                lucide.createIcons();
                showToast('Success', 'Results loaded successfully');
            } catch (err) {
                document.getElementById('formattedOutput').innerHTML = `
                    <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <p class="text-red-400 text-sm">Error loading JSON: ${err.message}</p>
                    </div>
                `;
                showToast('Error', 'Failed to load JSON', 'destructive');
            }
        }

        function displayFormattedOutput(data) {
            const formattedDiv = document.getElementById('formattedOutput');
            
            if (!data || !data.outputs) {
                formattedDiv.innerHTML = '<div class="text-center py-8 text-gray-400">No output data available</div>';
                return;
            }

            let html = '<div class="space-y-6">';

            // Group outputs by length
            const outputsByLength = {};
            data.outputs.forEach(output => {
                const length = output.length_requested || 'unknown';
                if (!outputsByLength[length]) {
                    outputsByLength[length] = [];
                }
                outputsByLength[length].push(output);
            });

            // Display each length group
            Object.entries(outputsByLength).forEach(([length, outputs], index) => {
                const colors = ['cyan', 'purple', 'green', 'yellow'];
                const color = colors[index % colors.length];
                
                html += `
                    <div class="output-section">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                Length ${length}
                            </h3>
                            <span class="badge badge-${color}">
                                Target: ${length}
                            </span>
                        </div>
                `;

                // Display outputs for this length
                outputs.forEach(output => {
                    const actualLength = output.len_actual || output.output?.length || 0;
                    const percentage = length !== 'unknown' ? ((actualLength / parseInt(length)) * 100).toFixed(1) : '0';
                    const language = output.language || 'English';
                    const languageColor = language.toLowerCase().includes('spanish') ? 'yellow' : 'cyan';
                    
                    html += `
                        <div class="output-item">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-${languageColor}-400 uppercase tracking-wider">
                                    ${language} Output
                                </h4>
                                <span class="badge badge-${languageColor}">
                                    ${actualLength} chars · ${percentage}%
                                </span>
                            </div>
                            <div class="bg-black/50 border border-gray-700 rounded p-3 mb-3">
                                <p class="text-gray-300 text-sm leading-relaxed">${output.output || 'No output available'}</p>
                            </div>
                            <button 
                                onclick="copyToClipboard('${escapeHtml(output.output || '')}', '${language}')"
                                class="px-3 py-1.5 bg-${languageColor}-500/20 text-${languageColor}-400 border border-${languageColor}-500/50 rounded hover:bg-${languageColor}-500/30 transition-all text-xs font-semibold flex items-center gap-1"
                            >
                                <i data-lucide="copy" class="w-3 h-3"></i>
                                Copy ${language.split(' ')[0]}
                            </button>
                        </div>
                    `;
                });

                html += '</div>';
            });

            // Display success rate if available
            if (data.success_rate !== undefined) {
                html += `
                    <div class="output-section">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-green-400"></i>
                                Success Rate
                            </h4>
                            <span class="badge badge-green">${data.success_rate}</span>
                        </div>
                    </div>
                `;
            }

            // Display target lengths if available
            if (data.lengths_requested && data.lengths_requested.length > 0) {
                html += `
                    <div class="output-section">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-white flex items-center gap-2">
                                <i data-lucide="target" class="w-4 h-4 text-purple-400"></i>
                                Target Lengths
                            </h4>
                            <div class="flex gap-2">
                                ${data.lengths_requested.map(len => `<span class="badge badge-purple">${len}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Display token usage analytics if available
            if (data.token_usage) {
                html += `
                    <div class="output-section">
                        <h4 class="text-sm font-bold text-white flex items-center gap-2 mb-4">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 text-cyan-400"></i>
                            Token Usage Analytics
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                `;

                const tokenSections = [
                    { title: 'English Processing', data: data.token_usage.english_processing, color: 'cyan' },
                    { title: 'Spanish Processing', data: data.token_usage.spanish_processing, color: 'yellow' },
                    { title: 'Total Usage', data: data.token_usage.total_usage, color: 'green' }
                ];

                tokenSections.forEach(section => {
                    if (section.data) {
                        html += `
                            <div class="bg-black/30 border border-gray-700 rounded p-3">
                                <h5 class="text-xs font-semibold text-${section.color}-400 mb-2">${section.title}</h5>
                                <div class="space-y-1 text-xs text-gray-300">
                                    ${section.data.input_tokens ? `<div>Input: <span class="text-white font-mono">${section.data.input_tokens}</span> tokens</div>` : ''}
                                    ${section.data.output_tokens ? `<div>Output: <span class="text-white font-mono">${section.data.output_tokens}</span> tokens</div>` : ''}
                                    ${section.data.attempts ? `<div>Attempts: <span class="text-white font-mono">${section.data.attempts}</span></div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            formattedDiv.innerHTML = html;
        }

        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
        }

        async function copyToClipboard(text, label) {
            try {
                // Unescape the text
                const unescaped = text.replace(/\\'/g, "'").replace(/\\"/g, '"').replace(/\\n/g, '\n');
                await navigator.clipboard.writeText(unescaped);
                showToast('Copied', `${label} output copied to clipboard`);
            } catch (err) {
                showToast('Error', 'Could not copy to clipboard', 'destructive');
            }
        }

        function toggleJsonSection() {
            const content = document.getElementById('jsonCollapsible');
            const chevron = document.getElementById('jsonChevron');
            content.classList.toggle('open');
            chevron.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        // Modal controls
        closeModal.addEventListener('click', () => {
            jsonModal.classList.remove('show');
        });

        jsonModal.addEventListener('click', (e) => {
            if (e.target === jsonModal) {
                jsonModal.classList.remove('show');
            }
        });

        copyJsonBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(jsonContent.textContent);
                showToast('Copied', 'JSON copied to clipboard');
            } catch (err) {
                showToast('Error', 'Could not copy to clipboard', 'destructive');
            }
        });

        downloadJsonBtn.addEventListener('click', () => {
            if (!currentJsonData || !currentFileName) return;
            
            const blob = new Blob([JSON.stringify(currentJsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Success', 'JSON downloaded');
        });

        // Make functions available globally
        window.viewJson = viewJson;
        window.copyToClipboard = copyToClipboard;
        window.toggleJsonSection = toggleJsonSection;

        // Initialize icons
        lucide.createIcons();
    </script>
</body>
</html>
