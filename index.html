<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Synopsis Transformer - Fabric AI Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
        .gradient-text { background: linear-gradient(to right,#22d3ee,#a855f7,#ec4899);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
        .gradient-bg { background: linear-gradient(to right,#0891b2,#7c3aed); }
        .gradient-bg:hover { background: linear-gradient(to right,#0e7490,#6d28d9); }
        .gradient-bg-green { background: linear-gradient(to right,#059669,#0891b2); }
        .gradient-bg-green:hover { background: linear-gradient(to right,#047857,#0e7490); }
        .toast { position: fixed; top:20px; right:20px; background:rgba(0,0,0,0.9); color:white;
            padding:12px 20px; border-radius:8px; border:1px solid #374151; z-index:1000;
            transform:translateX(100%); transition:transform 0.3s ease;}
        .toast.show { transform:translateX(0); }
        .file-drop-zone { border:2px dashed #374151; transition:all 0.3s ease; }
        .file-drop-zone.dragover { border-color:#22d3ee; background-color:rgba(34,211,238,0.05); }
    </style>
</head>
<body class="min-h-screen bg-black relative overflow-x-hidden">
    <div class="relative max-w-5xl mx-auto px-6 py-8">
        <!-- Header -->
        <div class="text-center space-y-4 mb-8">
            <h1 class="text-4xl font-bold gradient-text">Synopsis Transformer</h1>
            <p class="text-lg text-gray-300">Upload VTT files, process them, and browse results.</p>
        </div>

        <!-- Config -->
        <div class="border border-gray-800 bg-gray-900/50 rounded-lg mb-6 p-6 space-y-4">
            <label for="baseEndpoint" class="text-sm font-semibold text-cyan-400 uppercase tracking-wider flex items-center gap-2">
                <i data-lucide="link" class="w-4 h-4"></i>
                API Base Endpoint
            </label>
            <input id="baseEndpoint" type="text"
                placeholder="https://your-api-gateway-url"
                class="w-full font-mono text-sm bg-black/50 border border-gray-700 text-white
                placeholder-gray-500 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20
                rounded-md px-3 py-2 outline-none"/>
            <label for="userId" class="text-sm font-semibold text-green-400 uppercase tracking-wider flex items-center gap-2">
                <i data-lucide="user" class="w-4 h-4"></i>
                User ID
            </label>
            <input id="userId" type="text" placeholder="rafa"
                class="w-full font-mono text-sm bg-black/50 border border-gray-700 text-white
                placeholder-gray-500 focus:border-green-500 focus:ring-2 focus:ring-green-500/20
                rounded-md px-3 py-2 outline-none"/>
        </div>

        <!-- Upload -->
        <div class="border border-gray-800 bg-gray-900/50 rounded-lg mb-6 p-6 space-y-6">
            <h2 class="text-xl font-bold text-purple-400 flex items-center gap-2">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i> Upload Files
            </h2>
            <div id="fileDropZone" class="file-drop-zone p-6 rounded-lg text-center cursor-pointer">
                <input type="file" id="fileInput" accept=".vtt" multiple class="hidden">
                <p class="text-gray-400">Drop VTT files here or click to browse</p>
            </div>
            <div id="fileInfo" class="hidden p-2 bg-purple-500/10 rounded-md text-sm text-white"></div>
            <button id="uploadBtn" class="gradient-bg text-white px-6 py-2 rounded-md">Upload & Transform</button>
            <span id="uploadStatus" class="text-sm text-gray-400 font-mono"></span>
        </div>

        <!-- Results -->
        <div class="border border-gray-800 bg-gray-900/50 rounded-lg p-6 space-y-6">
            <h2 class="text-xl font-bold text-green-400 flex items-center gap-2">
                <i data-lucide="database" class="w-5 h-5"></i> Results
            </h2>
            <button id="fetchBtn" class="gradient-bg-green text-white px-6 py-2 rounded-md">Fetch Results</button>
            <div id="results" class="space-y-4">
                <p class="text-gray-400">No results yet...</p>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        lucide.createIcons();

        const uploadBtn = document.getElementById("uploadBtn");
        const fetchBtn = document.getElementById("fetchBtn");
        const uploadStatus = document.getElementById("uploadStatus");
        const resultsDiv = document.getElementById("results");
        const fileDropZone = document.getElementById("fileDropZone");
        const fileInput = document.getElementById("fileInput");
        const fileInfo = document.getElementById("fileInfo");
        let selectedFiles = [];

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(()=>toast.classList.add('show'),100);
            setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),300)},3000);
        }

        fileDropZone.addEventListener('click',()=>fileInput.click());
        fileInput.addEventListener('change',(e)=>handleFileSelect(e.target.files));
        fileDropZone.addEventListener('dragover',(e)=>{e.preventDefault();fileDropZone.classList.add('dragover');});
        fileDropZone.addEventListener('dragleave',()=>fileDropZone.classList.remove('dragover'));
        fileDropZone.addEventListener('drop',(e)=>{e.preventDefault();fileDropZone.classList.remove('dragover');handleFileSelect(e.dataTransfer.files);});

        function handleFileSelect(files){
            selectedFiles = Array.from(files);
            fileInfo.textContent = `${selectedFiles.length} file(s) selected`;
            fileInfo.classList.remove("hidden");
            showToast("Files ready");
        }

        uploadBtn.addEventListener("click",async()=>{
            const baseEndpoint=document.getElementById("baseEndpoint").value.trim();
            const userId=document.getElementById("userId").value.trim();
            if(!baseEndpoint||!userId||selectedFiles.length===0){showToast("Missing data");return;}
            uploadStatus.textContent="Uploading...";
            const fileArray=[];
            for(const f of selectedFiles){const text=await f.text();fileArray.push({file_name:f.name,file_content:text});}
            try{
                const resp=await fetch(`${baseEndpoint}/upload`,{
                    method:"POST",headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({user_id:userId,files:fileArray})
                });
                const data=await resp.json();
                if(resp.ok){uploadStatus.textContent="Success";showToast("Upload done");}
                else{uploadStatus.textContent="Error";showToast(JSON.stringify(data));}
            }catch(err){uploadStatus.textContent="Error";showToast(err.message);}
        });

        fetchBtn.addEventListener("click",async()=>{
            const baseEndpoint=document.getElementById("baseEndpoint").value.trim();
            const userId=document.getElementById("userId").value.trim();
            if(!baseEndpoint||!userId){showToast("Missing data");return;}
            resultsDiv.innerHTML="<p class='text-gray-400'>Loading...</p>";
            try{
                const resp=await fetch(`${baseEndpoint}/results`,{
                    method:"POST",headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({user_id:userId})
                });
                const data=await resp.json();
                if(!resp.ok){resultsDiv.innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;return;}
                const sessions=data.sessions||{};
                if(Object.keys(sessions).length===0){resultsDiv.innerHTML="<p>No results</p>";return;}
                let html="";
                for(const [session,details] of Object.entries(sessions)){
                    html+=`<div class="p-4 bg-gray-800 rounded"><h3 class="text-purple-400">Session: ${session}</h3><ul>`;
                    details.files.forEach(f=>{
                        const s3Url=`https://s3.console.aws.amazon.com/s3/object/synopsis-transformer-files?region=us-east-2&prefix=${f.key}`;
                        html+=`<li class="flex justify-between"><span>${f.key}</span><a href="${s3Url}" target="_blank" class="text-green-400">Download</a></li>`;
                    });
                    html+="</ul></div>";
                }
                resultsDiv.innerHTML=html;
            }catch(err){resultsDiv.innerHTML=`<pre>${err.message}</pre>`;}
        });
    </script>
</body>
</html>
