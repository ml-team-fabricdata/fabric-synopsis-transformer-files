<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Synopsis Transformer Results - Fabric AI Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
  <div class="w-full max-w-3xl p-6 bg-gray-800 rounded-lg shadow-lg space-y-6">
    <h1 class="text-2xl font-bold text-cyan-400">Results Browser</h1>

    <!-- API & User Inputs -->
    <div class="space-y-4">
      <div>
        <label class="block text-sm mb-1">API Endpoint</label>
        <input id="endpoint" type="text" placeholder="https://your-api-gateway-url/$default/results"
          class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:ring focus:ring-cyan-500"/>
      </div>
      <div>
        <label class="block text-sm mb-1">User ID</label>
        <input id="userId" type="text" placeholder="rafa"
          class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:ring focus:ring-cyan-500"/>
      </div>
      <button id="fetchBtn"
        class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded font-semibold">
        Fetch Results
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="space-y-4">
      <p class="text-gray-400">No results yet...</p>
    </div>
  </div>

  <script>
    const fetchBtn = document.getElementById("fetchBtn");
    const resultsDiv = document.getElementById("results");

    fetchBtn.addEventListener("click", async () => {
      const endpoint = document.getElementById("endpoint").value.trim();
      const userId = document.getElementById("userId").value.trim();
      if (!endpoint || !userId) {
        alert("Please enter both endpoint and user ID");
        return;
      }

      resultsDiv.innerHTML = "<p class='text-gray-400'>Loading...</p>";

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId })
        });

        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          resultsDiv.innerHTML = `<pre class="text-red-400">Invalid JSON:\n${text}</pre>`;
          return;
        }

        if (!response.ok) {
          resultsDiv.innerHTML = `<pre class="text-red-400">Error:\n${JSON.stringify(data, null, 2)}</pre>`;
          return;
        }

        // Render sessions
        const sessions = data.sessions || {};
        if (Object.keys(sessions).length === 0) {
          resultsDiv.innerHTML = "<p class='text-gray-400'>No sessions found</p>";
          return;
        }

        let html = "";
        for (const [session, details] of Object.entries(sessions)) {
          html += `
            <div class="p-4 bg-gray-700 rounded">
              <h2 class="font-bold text-lg text-purple-400">Session: ${session}</h2>
              <p class="text-sm text-gray-300">Files: ${details.count} Â· Size: ${details.total_size} bytes</p>
              <ul class="mt-2 space-y-2">
          `;
          details.files.forEach(file => {
            const s3Url = \`https://s3.console.aws.amazon.com/s3/object/synopsis-transformer-files?region=us-east-2&prefix=\${file.key}\`;
            html += `
              <li class="flex justify-between items-center bg-gray-800 px-3 py-2 rounded">
                <span class="text-sm">\${file.key} (\${file.size} bytes)</span>
                <a href="\${s3Url}" target="_blank"
                  class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                  Download
                </a>
              </li>
            `;
          });
          html += `</ul></div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (err) {
        resultsDiv.innerHTML = `<pre class="text-red-400">Error: ${err.message}</pre>`;
      }
    });
  </script>
</body>
</html>
